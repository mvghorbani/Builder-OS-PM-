-- ================================
-- CORE ENTITIES
-- ================================

-- Users and Authentication
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    first_name VARCHAR(100) NOT NULL,
    last_name VARCHAR(100) NOT NULL,
    phone VARCHAR(20),
    role VARCHAR(50) NOT NULL CHECK (role IN ('admin', 'pm', 'owner', 'vendor', 'viewer')),
    company_id UUID REFERENCES companies(id),
    is_active BOOLEAN DEFAULT true,
    last_login_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE companies (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(255) NOT NULL,
    type VARCHAR(50) CHECK (type IN ('general_contractor', 'owner', 'vendor', 'consultant')),
    address JSONB,
    phone VARCHAR(20),
    email VARCHAR(255),
    license_number VARCHAR(100),
    insurance_info JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Properties/Projects
CREATE TABLE properties (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    address TEXT NOT NULL,
    property_type VARCHAR(100) NOT NULL,
    project_type VARCHAR(100) NOT NULL,
    status VARCHAR(50) NOT NULL DEFAULT 'planning',
    owner_id UUID REFERENCES companies(id),
    pm_id UUID REFERENCES users(id),
    budget_total DECIMAL(12,2),
    budget_contingency DECIMAL(12,2),
    start_date DATE,
    target_completion DATE,
    actual_completion DATE,
    square_footage INTEGER,
    lot_size DECIMAL(10,2),
    coordinates POINT,
    permits_required JSONB,
    metadata JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ================================
-- SCHEDULE & MILESTONES
-- ================================

CREATE TABLE milestones (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    property_id UUID NOT NULL REFERENCES properties(id) ON DELETE CASCADE,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    milestone_type VARCHAR(50) NOT NULL,
    status VARCHAR(50) DEFAULT 'pending' CHECK (status IN ('pending', 'active', 'blocked', 'complete', 'cancelled')),
    planned_start DATE,
    planned_end DATE,
    actual_start DATE,
    actual_end DATE,
    dependencies JSONB, -- Array of milestone IDs
    blockers JSONB, -- Array of blocking conditions
    completion_percentage INTEGER DEFAULT 0 CHECK (completion_percentage >= 0 AND completion_percentage <= 100),
    assigned_to UUID REFERENCES users(id),
    created_by UUID REFERENCES users(id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ================================
-- FINANCIAL MANAGEMENT
-- ================================

CREATE TABLE budget_lines (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    property_id UUID NOT NULL REFERENCES properties(id) ON DELETE CASCADE,
    category VARCHAR(100) NOT NULL,
    scope_description TEXT NOT NULL,
    budgeted_amount DECIMAL(12,2) NOT NULL,
    committed_amount DECIMAL(12,2) DEFAULT 0,
    spent_amount DECIMAL(12,2) DEFAULT 0,
    vendor_id UUID REFERENCES companies(id),
    contract_number VARCHAR(100),
    milestone_id UUID REFERENCES milestones(id),
    requires_bids BOOLEAN DEFAULT true,
    minimum_bids INTEGER DEFAULT 3,
    status VARCHAR(50) DEFAULT 'budgeted',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE change_orders (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    property_id UUID NOT NULL REFERENCES properties(id) ON DELETE CASCADE,
    change_order_number VARCHAR(50) NOT NULL,
    title VARCHAR(255) NOT NULL,
    description TEXT,
    reason VARCHAR(500),
    cost_impact DECIMAL(12,2) NOT NULL,
    schedule_impact_days INTEGER DEFAULT 0,
    status VARCHAR(50) DEFAULT 'draft' CHECK (status IN ('draft', 'submitted', 'approved', 'rejected', 'executed')),
    requested_by UUID REFERENCES users(id),
    approved_by UUID REFERENCES users(id),
    vendor_id UUID REFERENCES companies(id),
    budget_line_id UUID REFERENCES budget_lines(id),
    approved_at TIMESTAMP,
    executed_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE invoices (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    property_id UUID NOT NULL REFERENCES properties(id) ON DELETE CASCADE,
    vendor_id UUID NOT NULL REFERENCES companies(id),
    invoice_number VARCHAR(100) NOT NULL,
    budget_line_id UUID REFERENCES budget_lines(id),
    invoice_amount DECIMAL(12,2) NOT NULL,
    retention_percentage DECIMAL(5,2) DEFAULT 5.00,
    retention_amount DECIMAL(12,2),
    net_amount DECIMAL(12,2),
    work_period_start DATE,
    work_period_end DATE,
    status VARCHAR(50) DEFAULT 'submitted' CHECK (status IN ('submitted', 'approved', 'paid', 'rejected', 'on_hold')),
    submitted_at TIMESTAMP,
    approved_at TIMESTAMP,
    paid_at TIMESTAMP,
    approved_by UUID REFERENCES users(id),
    notes TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ================================
-- PROCUREMENT & BIDDING
-- ================================

CREATE TABLE rfqs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    property_id UUID NOT NULL REFERENCES properties(id) ON DELETE CASCADE,
    budget_line_id UUID REFERENCES budget_lines(id),
    rfq_number VARCHAR(50) NOT NULL,
    title VARCHAR(255) NOT NULL,
    scope_description TEXT,
    bid_due_date TIMESTAMP,
    walkthrough_date TIMESTAMP,
    status VARCHAR(50) DEFAULT 'draft' CHECK (status IN ('draft', 'sent', 'closed', 'awarded', 'cancelled')),
    created_by UUID REFERENCES users(id),
    awarded_to UUID REFERENCES companies(id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE rfq_invitations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    rfq_id UUID NOT NULL REFERENCES rfqs(id) ON DELETE CASCADE,
    vendor_id UUID NOT NULL REFERENCES companies(id),
    invited_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    viewed_at TIMESTAMP,
    responded_at TIMESTAMP,
    UNIQUE(rfq_id, vendor_id)
);

CREATE TABLE bids (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    rfq_id UUID NOT NULL REFERENCES rfqs(id) ON DELETE CASCADE,
    vendor_id UUID NOT NULL REFERENCES companies(id),
    base_bid_amount DECIMAL(12,2) NOT NULL,
    alternates JSONB,
    unit_prices JSONB,
    timeline_days INTEGER,
    warranty_terms TEXT,
    exclusions TEXT,
    notes TEXT,
    status VARCHAR(50) DEFAULT 'submitted' CHECK (status IN ('draft', 'submitted', 'awarded', 'rejected')),
    submitted_at TIMESTAMP,
    expires_at TIMESTAMP,
    UNIQUE(rfq_id, vendor_id)
);

-- ================================
-- VENDOR MANAGEMENT
-- ================================

CREATE TABLE vendor_qualifications (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    vendor_id UUID NOT NULL REFERENCES companies(id) ON DELETE CASCADE,
    license_number VARCHAR(100),
    license_expiry DATE,
    bond_amount DECIMAL(12,2),
    bond_expiry DATE,
    insurance_general_liability DECIMAL(12,2),
    insurance_workers_comp BOOLEAN DEFAULT false,
    insurance_expiry DATE,
    emod_rate DECIMAL(5,2),
    safety_rating VARCHAR(20),
    prequalified BOOLEAN DEFAULT false,
    prequalified_until DATE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE vendor_performance (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    vendor_id UUID NOT NULL REFERENCES companies(id),
    property_id UUID NOT NULL REFERENCES properties(id),
    category VARCHAR(100), -- 'schedule', 'quality', 'safety', 'communication'
    rating INTEGER CHECK (rating >= 1 AND rating <= 5),
    comments TEXT,
    scored_by UUID REFERENCES users(id),
    scored_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ================================
-- PERMITS & COMPLIANCE
-- ================================

CREATE TABLE permits (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    property_id UUID NOT NULL REFERENCES properties(id) ON DELETE CASCADE,
    permit_type VARCHAR(100) NOT NULL,
    permit_number VARCHAR(100),
    description TEXT,
    status VARCHAR(50) DEFAULT 'required' CHECK (status IN ('required', 'applied', 'under_review', 'approved', 'issued', 'expired', 'rejected')),
    applied_date DATE,
    approved_date DATE,
    issued_date DATE,
    expiry_date DATE,
    fee_amount DECIMAL(10,2),
    issuing_authority VARCHAR(255),
    conditions TEXT,
    milestone_id UUID REFERENCES milestones(id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE safety_incidents (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    property_id UUID NOT NULL REFERENCES properties(id) ON DELETE CASCADE,
    incident_date TIMESTAMP NOT NULL,
    incident_type VARCHAR(100) NOT NULL,
    severity VARCHAR(50) CHECK (severity IN ('minor', 'major', 'serious', 'fatal')),
    description TEXT NOT NULL,
    injured_party VARCHAR(255),
    vendor_id UUID REFERENCES companies(id),
    actions_taken TEXT,
    root_cause TEXT,
    preventive_measures TEXT,
    reported_by UUID REFERENCES users(id),
    osha_reportable BOOLEAN DEFAULT false,
    workers_comp_claim BOOLEAN DEFAULT false,
    status VARCHAR(50) DEFAULT 'open' CHECK (status IN ('open', 'investigating', 'closed')),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ================================
-- COMMUNICATION & RFIs
-- ================================

CREATE TABLE rfis (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    property_id UUID NOT NULL REFERENCES properties(id) ON DELETE CASCADE,
    rfi_number VARCHAR(50) NOT NULL,
    subject VARCHAR(255) NOT NULL,
    question TEXT NOT NULL,
    priority VARCHAR(50) DEFAULT 'normal' CHECK (priority IN ('low', 'normal', 'high', 'urgent')),
    status VARCHAR(50) DEFAULT 'open' CHECK (status IN ('open', 'answered', 'closed')),
    submitted_by UUID REFERENCES users(id),
    assigned_to UUID REFERENCES users(id),
    vendor_id UUID REFERENCES companies(id),
    milestone_id UUID REFERENCES milestones(id),
    due_date DATE,
    answered_at TIMESTAMP,
    answer TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE daily_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    property_id UUID NOT NULL REFERENCES properties(id) ON DELETE CASCADE,
    log_date DATE NOT NULL,
    weather_am VARCHAR(100),
    weather_pm VARCHAR(100),
    temperature_high INTEGER,
    temperature_low INTEGER,
    work_performed TEXT,
    delays TEXT,
    safety_notes TEXT,
    quality_notes TEXT,
    visitors TEXT,
    deliveries TEXT,
    equipment_on_site TEXT,
    manpower JSONB, -- {trade: count} mapping
    logged_by UUID REFERENCES users(id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(property_id, log_date)
);

CREATE TABLE punch_list_items (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    property_id UUID NOT NULL REFERENCES properties(id) ON DELETE CASCADE,
    item_number VARCHAR(50),
    location VARCHAR(255) NOT NULL,
    trade VARCHAR(100),
    description TEXT NOT NULL,
    priority VARCHAR(50) DEFAULT 'normal' CHECK (priority IN ('low', 'normal', 'high')),
    status VARCHAR(50) DEFAULT 'open' CHECK (status IN ('open', 'in_progress', 'completed', 'verified', 'rejected')),
    assigned_to UUID REFERENCES companies(id),
    due_date DATE,
    identified_by UUID REFERENCES users(id),
    completed_at TIMESTAMP,
    verified_by UUID REFERENCES users(id),
    verified_at TIMESTAMP,
    cost_estimate DECIMAL(10,2),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ================================
-- DOCUMENTS & FILES
-- ================================

CREATE TABLE documents (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    property_id UUID REFERENCES properties(id) ON DELETE CASCADE,
    vendor_id UUID REFERENCES companies(id),
    milestone_id UUID REFERENCES milestones(id),
    rfi_id UUID REFERENCES rfis(id),
    punch_item_id UUID REFERENCES punch_list_items(id),
    change_order_id UUID REFERENCES change_orders(id),
    document_type VARCHAR(100) NOT NULL,
    title VARCHAR(255) NOT NULL,
    description TEXT,
    file_path VARCHAR(500) NOT NULL,
    file_name VARCHAR(255) NOT NULL,
    file_size BIGINT,
    mime_type VARCHAR(100),
    version INTEGER DEFAULT 1,
    is_current BOOLEAN DEFAULT true,
    uploaded_by UUID REFERENCES users(id),
    tags TEXT[],
    metadata JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ================================
-- COMMUNICATION
-- ================================

CREATE TABLE messages (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    property_id UUID REFERENCES properties(id),
    thread_id UUID, -- For grouping related messages
    sender_id UUID NOT NULL REFERENCES users(id),
    recipients UUID[] NOT NULL,
    subject VARCHAR(255),
    message_text TEXT NOT NULL,
    message_type VARCHAR(50) DEFAULT 'general' CHECK (message_type IN ('general', 'alert', 'status_update', 'escalation')),
    priority VARCHAR(50) DEFAULT 'normal',
    read_by JSONB DEFAULT '{}', -- {user_id: timestamp} mapping
    attachments UUID[], -- document IDs
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE meetings (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    property_id UUID REFERENCES properties(id),
    meeting_type VARCHAR(100) NOT NULL,
    title VARCHAR(255) NOT NULL,
    agenda TEXT,
    meeting_date TIMESTAMP NOT NULL,
    duration_minutes INTEGER,
    location VARCHAR(255),
    organizer_id UUID REFERENCES users(id),
    attendees UUID[] NOT NULL,
    minutes TEXT,
    action_items JSONB,
    next_meeting TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ================================
-- REPORTING & ANALYTICS
-- ================================

CREATE TABLE kpi_snapshots (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    property_id UUID NOT NULL REFERENCES properties(id) ON DELETE CASCADE,
    snapshot_date DATE NOT NULL,
    schedule_adherence DECIMAL(5,2),
    budget_variance DECIMAL(5,2),
    safety_incidents INTEGER DEFAULT 0,
    permit_sla_days INTEGER,
    vendor_performance_avg DECIMAL(3,2),
    change_order_count INTEGER DEFAULT 0,
    change_order_value DECIMAL(12,2) DEFAULT 0,
    rfi_count INTEGER DEFAULT 0,
    rfi_avg_response_days DECIMAL(5,2),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(property_id, snapshot_date)
);

-- ================================
-- INDEXES FOR PERFORMANCE
-- ================================

CREATE INDEX idx_properties_owner ON properties(owner_id);
CREATE INDEX idx_properties_pm ON properties(pm_id);
CREATE INDEX idx_properties_status ON properties(status);
CREATE INDEX idx_milestones_property ON milestones(property_id);
CREATE INDEX idx_milestones_status ON milestones(status);
CREATE INDEX idx_budget_lines_property ON budget_lines(property_id);
CREATE INDEX idx_invoices_property ON invoices(property_id);
CREATE INDEX idx_invoices_vendor ON invoices(vendor_id);
CREATE INDEX idx_invoices_status ON invoices(status);
CREATE INDEX idx_permits_property ON permits(property_id);
CREATE INDEX idx_permits_expiry ON permits(expiry_date) WHERE expiry_date IS NOT NULL;
CREATE INDEX idx_documents_property ON documents(property_id);
CREATE INDEX idx_documents_type ON documents(document_type);
CREATE INDEX idx_messages_property ON messages(property_id);
CREATE INDEX idx_messages_sender ON messages(sender_id);
CREATE INDEX idx_daily_logs_property_date ON daily_logs(property_id, log_date);
CREATE INDEX idx_punch_list_property ON punch_list_items(property_id);
CREATE INDEX idx_punch_list_status ON punch_list_items(status);
CREATE INDEX idx_kpi_snapshots_property_date ON kpi_snapshots(property_id, snapshot_date);

-- ================================
-- FUNCTIONS & TRIGGERS
-- ================================

-- Update timestamp trigger
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ language 'plpgsql';

-- Apply to relevant tables
CREATE TRIGGER update_properties_updated_at BEFORE UPDATE ON properties FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
CREATE TRIGGER update_milestones_updated_at BEFORE UPDATE ON milestones FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
CREATE TRIGGER update_budget_lines_updated_at BEFORE UPDATE ON budget_lines FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
CREATE TRIGGER update_invoices_updated_at BEFORE UPDATE ON invoices FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
-- Add similar triggers for other tables...